<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Architext Site Solver</title>
  <style>
    * { box-sizing: border-box; }
<!-- styles the body of the website -->
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb; color: #333; padding: 40px 20px;
      display: flex; justify-content: center;
    }
<!-- styles the main element (the central container for the site’s content) -->
    main {
      width: 100%; max-width: 720px; background: white; border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); padding: 40px 50px;
    }
<!-- styles all h2 headings on the page (makes them bigger, bolded, and centered) –>
    h2 { margin-top: 0; margin-bottom: 30px; font-weight: 700; font-size: 2rem; color: #1a202c; text-align: center; }
<!-- styles the label elements (makes them look clean, clear, and spaced-out) –>
    label { display: block; font-weight: 600; margin-bottom: 10px; color: #4a5568; font-size: 1rem; }
<!-- styles text inputs, number inputs, dropdowns (select), and text areas so they look put-together –>
    input[type="text"], input[type="number"], select, textarea {
      width: 100%; padding: 14px 16px; font-size: 1.1rem; border: 2px solid #cbd5e0;
      border-radius: 6px; transition: border-color .3s ease; font-family: inherit; box-sizing: border-box;
    }
    input[type="text"]:focus:not(:disabled),
    input[type="number"]:focus:not(:disabled),
    select:focus:not(:disabled),
    textarea:focus { outline: none; border-color: #3182ce; box-shadow: 0 0 7px #3182ceaa; }
    input:disabled, select:disabled { background-color: #e2e8f0; color: #a0aec0; cursor: not-allowed; }
<!-- styles the button and defines how it should work (changes color depending on whether it is being interacted with or not) –>
    button {
      margin-top: 20px; width: 100%; padding: 14px; font-size: 1.1rem; font-weight: 600;
      background-color: #3182ce; border: none; border-radius: 6px; color: white; cursor: pointer; transition: background-color .3s ease;
    }
    button:hover:not(:disabled) { background-color: #2c5282; }
    button:active:not(:disabled) { background-color: #2a4365; }
    button:disabled { background-color: #a0aec0; cursor: not-allowed; }
<!-- styles the subheadings –>
    h3 { margin-top: 40px; font-weight: 700; font-size: 1.5rem; color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
<!-- styling output box –>
    pre {
      background: #edf2f7; border-radius: 6px; padding: 18px; font-family: Consolas, Monaco, monospace;
      font-size: 1rem; line-height: 1.5; white-space: pre-wrap; margin-top: 15px; min-height: 50px;
      color: #2d3748; box-shadow: inset 0 0 6px #cbd5e0; user-select: text;
    }
<!-- styling the text area and introducing a modal window –>
    textarea#output { resize: vertical; min-height: 180px; }
    /* Modal */
    #infoModal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 1000;
      justify-content: center; align-items: center; overflow: auto; padding: 40px 20px;
    }
<!-- styling the modal window –>
    #infoModalContent {
      background: white; border-radius: 8px; padding: 25px 35px; width: 90%; max-width: 800px;
      box-shadow: 0 10px 30px rgba(0,0,0,.3); font-family: Consolas, monospace; white-space: pre-wrap;
      max-height: 80vh; overflow-y: auto; color: #1a202c;
    }
<!-- close button inside the modal –>
    #infoModalClose { margin-top: 15px; text-align: right; font-size: 1rem; color: #3182ce; cursor: pointer; user-select: none; }
    #buildingsSection { margin-bottom: 30px; }
    #generatedImage {
      margin-top: 30px; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,.2);
    }
<!-- loading indicator, tells you that the image is being made –>
    #loadingText { margin-top: 15px; color: #3182ce; font-weight: 600; display: none; text-align: center; }
  </style>
</head>
<body>
  <main>
    <h2>Architext Site Solver</h2>

<!-- lets the user input an address, and this system finds the parcel number of the address –>
    <!-- Parcel Info Lookup -->
    <section id="parcelLookupSection">
      <h3>Parcel Info Lookup</h3>
      <label for="addressInput">Enter address</label>
      <input type="text" id="addressInput" placeholder="e.g. 6 S Water St, Mobile, AL" autocomplete="off" spellcheck="false" />
      <button onclick="lookupParcel()">Lookup</button>

      <h3>Parcel Number:</h3>
      <pre id="parcelNumberOutput"></pre>
    </section>

    <hr style="margin: 40px 0;" />

<!-- let's let the user input what they want to be put in the parcel –>
    <div id="buildingsSection">
      <label for="numBuildings">Number of Buildings (1–20)</label>
      <input type="number" id="numBuildings" min="1" max="20" placeholder="Enter number of buildings" />
    </div>

    <label for="address">Building Address</label>
    <input type="text" id="address" disabled />

    <label for="acreage">Acreage (e.g. 2.35)</label>
    <input type="text" id="acreage" disabled />

    <label for="area">Area (sq ft)</label>
    <input type="text" id="area" disabled />

    <label for="length">Length (ft)</label>
    <input type="text" id="length" disabled />

    <label for="zoneType">Zone Type</label>
    <select id="zoneType" disabled>
      <option>Residential</option>
      <option>High-Density Residential</option>
      <option>Commercial</option>
      <option>Mixed Use</option>
    </select>

<!-- let's the user press the “generate plan & create image” button, and the AI generates text and an image –>
    <button onclick="generatePlan()" disabled id="generateBtn">Generate Plan & Create Image</button>

    <label for="output">Generated Site Plan</label>
    <textarea id="output" rows="20" readonly></textarea>

    <div id="loadingText">Generating image, please wait...</div>
    <img id="generatedImage" alt="Generated site master plan visualization" style="display:none;" />
  </main>

  <!-- Modal -->
  <div id="infoModal">
    <div id="infoModalContent">
      <div id="infoModalText">Loading info...</div>
      <div id="infoModalClose" onclick="closeModal()">Close</div>
    </div>
  </div>

  <!-- Socket.IO client for realtime broadcast -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

<script>
  /**
   * THE FOLLOWING LINES CONTAINS A BACK-END API KEY HOLDING SERVER. 
   * THIS IS USED SO THE API KEY NEVER IS SEEN ON THE USER-END OF THE BROWSER.
   * THIS PREVENTS THE USER FROM SEEING THE SENSITIVE API KEY.
   */
  const RENDER_BASE_URL = "https://openai-api-key-kx2c.onrender.com"; // ← THE SERVER ADDRESS (USING RENDER)

  let parcelInfo = null;
/** variables */
  const numBuildingsInput = document.getElementById('numBuildings');
  const addressField = document.getElementById('address');
  const acreageField = document.getElementById('acreage');
  const areaField = document.getElementById('area');
  const lengthField = document.getElementById('length');
  const zoneTypeSelect = document.getElementById('zoneType');
  const generateBtn = document.getElementById('generateBtn');
  const output = document.getElementById("output");
  const loadingText = document.getElementById("loadingText");
  const generatedImage = document.getElementById("generatedImage");
/** resets and locks the form */
  function disableFields() {
    [addressField, acreageField, areaField, lengthField, zoneTypeSelect, generateBtn].forEach(f => {
      f.disabled = true;
      if (f.tagName !== 'SELECT') f.value = '';
      else f.selectedIndex = 0;
    });
  }
  disableFields();
/** unlocks the form */
  function enableFields() {
    [addressField, acreageField, areaField, lengthField, zoneTypeSelect, generateBtn].forEach(f => { f.disabled = false; });
  }
/** ensures that users cannot input a number lower than 0 or higher than 20 */
  numBuildingsInput.addEventListener('input', () => {
    let val = parseInt(numBuildingsInput.value, 10);
    if (!val || val < 1) {
      numBuildingsInput.value = '';
      disableFields();
      return;
    }
    if (val > 20) { numBuildingsInput.value = 20; val = 20; }
    enableFields();
    if (parcelInfo) fillFieldsFromParcelInfo(parcelInfo);
  });
/** auto-fills parcel details */
  function fillFieldsFromParcelInfo(info) {
    addressField.value = info.address !== "N/A" ? info.address : "";
    acreageField.value = info.acreage !== "N/A" ? info.acreage : "";
    areaField.value = info.area !== "N/A" ? info.area : "";
    lengthField.value = info.length !== "N/A" ? info.length : "";
    const zone = (info.zone_type ?? "").toLowerCase();
    if (zone.includes("commercial")) zoneTypeSelect.selectedIndex = 2;
    else if (zone.includes("high-density")) zoneTypeSelect.selectedIndex = 1;
    else if (zone.includes("mixed")) zoneTypeSelect.selectedIndex = 3;
    else zoneTypeSelect.selectedIndex = 0;
  }
/** looks up parcel number */
  async function lookupParcel() {
    const addressInput = document.getElementById("addressInput");
    const parcelNumberOutput = document.getElementById("parcelNumberOutput");
    const address = addressInput.value.trim();

    parcelNumberOutput.textContent = "Looking up address...";
    if (!address) { parcelNumberOutput.textContent = "Please enter an address."; return; }
/** getting information about the address */
    try {
      const osmUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const osmRes = await fetch(osmUrl);
      const osmData = await osmRes.json();
      if (!osmData.length) { parcelNumberOutput.textContent = "Address not found via OpenStreetMap."; return; }
      const lat = osmData[0].lat;
      const lon = osmData[0].lon;

      const arcgisUrl = `https://services3.arcgis.com/AcvBA1fcgucsFQvO/arcgis/rest/services/PARCEL_DETAILS/FeatureServer/0/query` +
        `?geometry=${lon},${lat}` +
        `&geometryType=esriGeometryPoint` +
        `&inSR=4326&spatialRel=esriSpatialRelIntersects` +
        `&outFields=*` +
        `&returnGeometry=false` +
        `&f=json`;

      const parcelRes = await fetch(arcgisUrl);
      const parcelData = await parcelRes.json();
/** if the user inputs an address outside Mobile, this tells them to make sure the address is in Mobile. */
      if (!parcelData.features || !parcelData.features.length) {
        parcelNumberOutput.textContent = "No parcel information found for that location. Ensure it is an address in Mobile, AL.";
        return;
      }

      const props = parcelData.features[0].attributes;

      parcelInfo = {
        parcel_number: props.parcel ?? "N/A",
        alt_parcel_id: props.ptext ?? "N/A",
        address: props.address ?? "N/A",
        acreage: props.acreage ?? "N/A",
        area: props.Shape__Area ?? props.Shape_Area ?? "N/A",
        length: props.Shape__Length ?? props.Shape_Leng ?? "N/A",
        historical_district: props.historicdistrict ?? props.HISTORICDISTRIC ?? null,
        sq_footage: props.sq_feet ?? props.SQ_FOOTAGE ?? "N/A",
        zone_type: props.classcode_desc ?? "N/A"
      };

      parcelNumberOutput.textContent = parcelInfo.parcel_number;

      let numBuildingsVal = parseInt(numBuildingsInput.value, 10);
      if (numBuildingsVal >= 1 && numBuildingsVal <= 20) {
        fillFieldsFromParcelInfo(parcelInfo);
        enableFields();
      } else {
        disableFields();
      }

      output.value = "";
      generatedImage.style.display = "none";

      console.log("Stored Parcel Info:", parcelInfo);
    } catch (err) {
      parcelNumberOutput.textContent = "Error: " + err.message;
    }
  }

  async function generatePlan() {
    const address = addressField.value;
    const acreage = acreageField.value;
    const area = parseFloat(areaField.value);
    const length = parseFloat(lengthField.value);
    const zoneType = zoneTypeSelect.value;
    const numBuildings = parseInt(numBuildingsInput.value);

    if (!numBuildings || numBuildings < 1 || numBuildings > 20) {
      output.value = "Please enter a valid number of buildings (1–20).";
      return;
    }
    if (!area || isNaN(area) || !length || isNaN(length)) {
      output.value = "Please ensure Area and Length fields contain valid numbers.";
      return;
    }

    const width = (area / length).toFixed(2);
    const buildingWidth = (width / numBuildings).toFixed(2);

    let buildings = "";
    for (let i = 1; i <= numBuildings; i++) {
      buildings += `Building ${i}: ${buildingWidth}' x ${length}'\n`;
    }

    let buildingSize = (buildingWidth * 0.7).toFixed(2);
    let buildingDepth = (length * 0.8).toFixed(2);
    let buildingDesc = "";
    let inclusionDesc = "";

    const zoneLower = zoneType.toLowerCase();

    if (zoneLower.includes("commercial")) {
      buildingDesc = "Recommended commercial building (custom size).";
      inclusionDesc = "- Parking lot included.\n";
    } else if (zoneLower.includes("high-density")) {
      buildingDesc = `Suggested multi-family housing (~${buildingSize}' x ${buildingDepth}')`;
      inclusionDesc = "- Driveway included.\n- Sidewalk included.\n";
    } else if (zoneLower.includes("mixed")) {
      buildingDesc = `Suggested mixed-use building (~${buildingSize}' x ${buildingDepth}')`;
      inclusionDesc = "- Driveway included.\n- Parking spaces included.\n";
    } else {
      buildingDesc = `Suggested 3 bed / 2 bath home (~${buildingSize}' x ${buildingDepth}')`;
      inclusionDesc = "- Approx. 1-car driveway (10' x 20').\n";
    }

    let historicalNote = "";
    if (parcelInfo && parcelInfo.historical_district && parcelInfo.historical_district.trim() !== "") {
      historicalNote = "YES, In a historical designated area.";
    } else {
      historicalNote = "NO, Not in a historical designated area.";
    }

    const plan = `Site Master Plan

Location: ${address}
Zone: ${zoneType}
Acreage: ${acreage}
Area: ${area} sq ft
Length: ${length} ft
Historical District: ${historicalNote}

Buildings:
${buildings}
Each building includes:
${inclusionDesc}- ${buildingDesc}

North is assumed to be up.
`;

    output.value = plan;

    await generateImage(plan);
  }

  function summarizePlan(plan) {
    const lines = plan.split('\n');
    const summaryLines = [];

    for (let line of lines) {
      if (
        line.startsWith("Location:") ||
        line.startsWith("Zone:") ||
        line.startsWith("Acreage:") ||
        line.startsWith("Area:") ||
        line.startsWith("Length:") ||
        line.startsWith("Historical District:") ||
        line.startsWith("Building ") ||
        line.startsWith("-")
      ) {
        summaryLines.push(line);
      }
      if (summaryLines.length >= 12) break;
    }

    return summaryLines.join('\n');
  }

  async function generateImage(planText) {
    loadingText.style.display = "block";
    generatedImage.style.display = "none";
    generatedImage.src = "";

    const summary = summarizePlan(planText);

    // The prompt goes to MY backend (Render). My key never touches the browser.
    const prompt = `
Generate exactly what is described in the site plan. Nothing more. Only generate the set amount of buildings. One building counts as a separated structure. Generate a professional architectural site master plan in a top-down 2D view. Use only black, grey, and white colors. Show completed buildings with measurements (widths and lengths in feet). The style must be of a clean, minimalist blueprint or technical drawing with precise lines and legible text. Include only the number of buildings identified in the summary. Prior to sending the image, ensure there is the set amount of buildings. Strictly follow the details of the site plan.

Details of the site plan:
${summary}
`.trim();

    const truncatedPrompt = prompt.length > 3000 ? prompt.substring(0, 3000) : prompt;

    try {
      const res = await fetch(`${RENDER_BASE_URL}/image`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: truncatedPrompt })
      });

      if (!res.ok) {
        // Helpful message for common CORS/URL mistakes
        const msg = `Backend error (${res.status}). Check:
- RENDER_BASE_URL is correct
- Render CORS ALLOWED_ORIGIN matches your GitHub Pages URL
- /image endpoint exists and returns {url or b64}`;
        output.value = msg;
        return;
      }

      const data = await res.json();

      if (data.error) {
        output.value = "Image generation error: " + data.error;
        return;
      }

      // Support either {url} or {b64} from your backend
      if (data.url) {
        generatedImage.src = data.url;
      } else if (data.b64) {
        generatedImage.src = `data:image/png;base64,${data.b64}`;
      } else {
        output.value = "Image generation error: backend did not return url or b64.";
        return;
      }

      generatedImage.style.display = "block";
    } catch (error) {
      output.value = "Image generation error: " + error.message;
    } finally {
      loadingText.style.display = "none";
    }
  }

  function closeModal() {
    document.getElementById("infoModal").style.display = "none";
  }

  // Keep your original Ctrl+Y toggle (design unchanged)
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key.toLowerCase() === 'y') {
      e.preventDefault();
      toggleDebugModal();
    }
  });

  function toggleDebugModal() {
    const modal = document.getElementById("infoModal");
    if (modal.style.display === "flex") {
      modal.style.display = "none";
    } else {
      modal.style.display = "flex";
      updateDebugInfo();
      ensureBroadcastSection();            // add broadcast UI (does not alter existing design)
      const t = document.getElementById("bcText");
      if (t) setTimeout(() => t.focus(), 0);
    }
  }

  function updateDebugInfo() {
    const modalText = document.getElementById("infoModalText");
    const numBuildingsVal = numBuildingsInput.value;
    const addressVal = addressField.value;
    const acreageVal = acreageField.value;
    const areaVal = areaField.value;
    const lengthVal = lengthField.value;
    const zoneTypeVal = zoneTypeSelect.value;
    const generatedText = output.value;

    const debugInfo = `
--- Development Debug Info ---

parcelInfo Object:
${JSON.stringify(parcelInfo, null, 2)}

Form Inputs:
- Number of Buildings: ${numBuildingsVal}
- Address: ${addressVal}
- Acreage: ${acreageVal}
- Area: ${areaVal}
- Length: ${lengthVal}
- Zone Type: ${zoneTypeVal}

Generated Plan Text:
${generatedText}

Image Element:
- src: ${generatedImage.src}
- visible: ${generatedImage.style.display !== "none"}

Loading State:
- loadingText visible: ${loadingText.style.display !== "none"}
    `.trim();

    modalText.textContent = debugInfo;
  }

  /* =========================
     Broadcast system (adds UI to the existing Ctrl+Y modal
     without changing its overall design)
     ========================= */
  function ensureBroadcastSection() {
    // If we've already added it, do nothing
    if (document.getElementById("broadcastSection")) return;

    const content = document.getElementById("infoModalContent");

    // Divider to separate existing debug info from broadcast controls
    const divider = document.createElement("div");
    divider.style.cssText = "height:1px;background:#e2e8f0;margin:16px 0;";
    content.insertBefore(divider, document.getElementById("infoModalClose"));

    // Section container
    const section = document.createElement("div");
    section.id = "broadcastSection";
    section.style.cssText = "font-family: inherit; white-space: normal;";

    const title = document.createElement("h3");
    title.textContent = "Broadcast";
    title.style.marginTop = "10px";
    section.appendChild(title);

    // Message textarea
    const ta = document.createElement("textarea");
    ta.id = "bcText";
    ta.rows = 4;
    ta.placeholder = "Type a message to broadcast to all active sessions…";
    ta.style.cssText = "width:100%;padding:12px;border:2px solid #cbd5e0;border-radius:6px;margin-top:8px;";
    section.appendChild(ta);

    // Passphrase + Send row
    const row = document.createElement("div");
    row.style.cssText = "display:flex;gap:10px;align-items:center;margin-top:10px;";

    const pass = document.createElement("input");
    pass.id = "bcPass";
    pass.type = "password";
    pass.placeholder = "Admin passphrase";
    pass.style.cssText = "flex:1;padding:12px;border:2px solid #cbd5e0;border-radius:6px;";
    row.appendChild(pass);

    const send = document.createElement("button");
    send.id = "bcSend";
    send.textContent = "Send";
    send.style.marginTop = "0"; // use your global button styling
    row.appendChild(send);

    section.appendChild(row);

    // Error line
    const err = document.createElement("div");
    err.id = "bcError";
    err.style.cssText = "color:#e53e3e;margin-top:8px;display:none;";
    section.appendChild(err);

    // Feed header
    const feedHdr = document.createElement("div");
    feedHdr.textContent = "Incoming broadcasts (newest first):";
    feedHdr.style.cssText = "color:#718096;font-size:0.95rem;margin-top:14px;";
    section.appendChild(feedHdr);

    // Feed list
    const feed = document.createElement("ul");
    feed.id = "broadcastFeed";
    feed.style.cssText = "list-style:none;padding:0;margin:8px 0 0 0;";
    section.appendChild(feed);

    // Insert above existing Close link
    content.insertBefore(section, document.getElementById("infoModalClose"));

    // Wire events once UI exists
    send.addEventListener("click", sendBroadcast);
    ta.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        sendBroadcast();
      }
    });
  }

  function showBcError(msg) {
    const el = document.getElementById("bcError");
    if (!el) return;
    el.textContent = msg;
    el.style.display = "block";
  }

  function addBroadcastToFeed(text, ts) {
    const ul = document.getElementById("broadcastFeed");
    if (!ul) return;
    const li = document.createElement("li");
    li.style.cssText = "background:#fff;border:1px solid #e2e8f0;border-radius:6px;padding:10px 12px;margin-bottom:10px;line-height:1.4;font-size:0.95rem;";
    const time = new Date(ts).toLocaleString();
    li.innerHTML = `<div style="font-weight:600;">${escapeHtml(text)}</div><div style="color:#718096;margin-top:4px;">${time}</div>`;
    ul.insertBefore(li, ul.firstChild);
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function showToast(msg) {
    const bar = document.createElement("div");
    bar.textContent = msg;
    bar.style.cssText = `
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 24px; max-width: 90vw;
      background: #1a202c; color:#fff; padding: 12px 16px;
      border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,.25); z-index: 2000;
      font-weight:600; text-align:center;
    `;
    document.body.appendChild(bar);
    setTimeout(() => {
      bar.style.opacity = "0";
      bar.style.transition = "opacity .4s ease";
      setTimeout(() => bar.remove(), 400);
    }, 4000);
  }

  // Socket.IO client: receive live broadcasts
  const socket = io(RENDER_BASE_URL, { transports: ["websocket", "polling"] });
  socket.on("broadcast", (payload) => {
    const text = typeof payload === "object" && payload?.text ? payload.text : String(payload);
    const ts = typeof payload === "object" && payload?.ts ? payload.ts : Date.now();
    addBroadcastToFeed(text, ts);
    showToast(text);
  });

  // Send broadcast to backend
  async function sendBroadcast() {
    const textEl = document.getElementById("bcText");
    const passEl = document.getElementById("bcPass");
    if (!textEl || !passEl) return;

    const text = (textEl.value || "").trim();
    const passphrase = (passEl.value || "").trim();

    if (!text) { showBcError("Please enter a message."); return; }
    if (!passphrase) { showBcError("Passphrase required."); return; }

    try {
      const res = await fetch(`${RENDER_BASE_URL}/broadcast`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, passphrase })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);

      // Optimistic UI update
      addBroadcastToFeed(text, Date.now());
      textEl.value = "";
      const errEl = document.getElementById("bcError");
      if (errEl) errEl.style.display = "none";
      showToast("Broadcast sent");
    } catch (e) {
      showBcError("Failed to send: " + e.message);
    }
  }
</script>
</body>
</html>
